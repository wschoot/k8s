---
- hosts: all
  become: true
  tasks:
    - name: Disable SELinux
      selinux:
        state: disabled

    - name: Enable password login
      lineinfile: 
        dest: '/etc/ssh/sshd_config' 
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication yes"
      notify: restart sshd

    - name: Stop firewalld
      service: 
        name: firewalld
        state: stopped

    - name: Add repository
      yum_repository:
        name: kubernetes
        description: Kubernetes
        baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
        enabled: yes
        gpgcheck: yes
        repo_gpgcheck: yes
        gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg

    - name: upgrade all packages
      yum:
        name: tmux
        state: latest
        update_cache: yes

    - name: Install alles wat met kube begint
      package: 
        name: "{{ item }}"
        state: installed
      with_items:
        - kubelet 
        - kubeadm 
        - kubectl

    - name: Install docker
      package: 
        name: '{{ item }}'
        state: installed
      with_items:
        - docker
        - etcd
        - docker-distribution

    - name: Start kubelet
      service: 
        name: "{{ item }}" 
        state: started
        enabled: yes
      with_items:
        - kubelet
        - docker-distribution 
        - docker

    - name: Disable swapoff
      shell: swapoff -a

    - name: Disable swapoff permanently
      replace:
        path: /etc/fstab
        regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
        replace: '#\1\2\3swap\4'
        backup: yes

    - name: Change sysctl
      copy:
        src: files/sysctl.d-k8s.conf
        dest: /etc/sysctl.d/k8s.conf
        owner: root
        group: root
        mode: 0600
      register: sysctl

    - name: apply sysctl
      command: sysctl --system
      when: sysctl.changed

  handlers:
    - name: restart sshd
      service: 
        name: 'sshd'
        state: restarted
  


- hosts: master
  become: true
  tasks:
    - name: Copy yaml files
      become: false
      copy: 
        src: "{{ item }}"
        dest: "~/"
      with_fileglob:
        - files/dashboard*.yaml

    - name: Configure .bashrc
      lineinfile:
        dest: /root/.bashrc
        line: "{{ item }}"
      with_items:
        - 'export KUBECONFIG=/etc/kubernetes/admin.conf'
        - 'source <(kubectl completion bash)'
        - 'alias k=kubectl'
        - 'complete -F __start_kubectl k'

    #- name: kubeadm config pull
    #  command: kubeadm config images pull
# TODO idempotent

    - name: kubeadm init
      command: >
        kubeadm init 
        --pod-network-cidr 10.244.0.0/16 
        --apiserver-advertise-address "{{ ansible_eth1.ipv4.address }}"
      args:
        creates: /etc/kubernetes/admin.conf

    - name: kube flannel
      command: kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml

    - name: kube dashboard
      command: kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml

    - name: kube clusteradmin
      command: kubectl --kubeconfig=/etc/kubernetes/admin.conf create clusterrolebinding --user system:serviceaccount:kube-system:default kube-system-cluster-admin --clusterrole cluster-admin

    - name: kube dashboardadmin
      command: kubectl --kubeconfig=/etc/kubernetes/admin.conf create clusterrolebinding kubernetes-dashboard --clusterrole=cluster-admin --serviceaccount=kube-system:kubernetes-dashboard

    - name: kube adminuser
      command: kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f ~vagrant/dashboard-adminuser.yaml

    - name: kube adminrole
      command: kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f ~vagrant/dashboard-adminrole.yaml


# TODO Nieuwere ymls https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml

    - name: Get join link
      command: kubeadm token create --print-join-command
      register: joinlink

# https://docs.ansible.com/ansible/latest/user_guide/playbooks_delegation.html

    - name: Join workers {{ item }}
      command: "{{ joinlink.stdout }}"
      delegate_to: "{{ item }}"
      ignore_errors: yes
      with_items: "{{groups['nodes']}}"
        
    - name: Start proxy
      command: kubectl proxy
      async: 2592000               # 60*60*24*30 â€“ 1 month
      poll: 0

    #- name: "Add K8S Token and Hash to dummy host"
    #  add_host:
    #    name:   "K8S_TOKEN_HOLDER"
    #    joinlink:  "{{ joinlink.stdout }}"
#
#- hosts: nodes
## SCope https://liquidat.wordpress.com/2017/09/13/howto-reference-ansible-variables-between-plays/
#  tasks:
#    - name: Get join link
#      command: "{{ hostvars['K8S_TOKEN_HOLDER']['joinlink'] }}"
