---
- hosts: all
  become: true
  tasks:
    - name: Disable SELinux
      selinux:
        state: disabled

    - name: Enable password login
      lineinfile:
        dest: '/etc/ssh/sshd_config'
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication yes"
      notify: restart sshd

    - name: Stop firewalld
      service:
        name: firewalld
        state: stopped

    - name: Add repository
      yum_repository:
        name: kubernetes
        description: Kubernetes
        baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
        enabled: yes
        gpgcheck: yes
        repo_gpgcheck: yes
        gpgkey:
          - https://packages.cloud.google.com/yum/doc/yum-key.gpg
          - https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg

    - name: upgrade all packages
      yum:
        name: tmux
        state: latest
        update_cache: yes

    - name: Install alles wat met kube begint
      package:
        name: "{{ item }}"
        state: installed
      with_items:
        - kubelet
        - kubeadm
        - kubectl

    - name: Install docker
      package:
        name: '{{ item }}'
        state: installed
      with_items:
        - docker
        - etcd
        - docker-distribution

    - name: Start kubelet
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      with_items:
        - kubelet
        - docker-distribution
        - docker

    - name: Disable swapoff
      command: swapoff -a

    - name: Disable swapoff permanently
      replace:
        path: /etc/fstab
        regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
        replace: '#\1\2\3swap\4'
        backup: yes

    - name: Change sysctl
      copy:
        src: files/sysctl.d-k8s.conf
        dest: /etc/sysctl.d/k8s.conf
        owner: root
        group: root
        mode: 0600
      notify: restart sysctl

  handlers:
    - name: restart sysctl
      command: sysctl --system

    - name: restart sshd
      service:
        name: sshd
        state: restarted

- hosts: master
  become: true
  tasks:
    - name: Copy yaml files
      become: false
      copy:
        src: "{{ item }}"
        dest: "~/"
      with_fileglob:
        - files/dashboard*.yaml

    - name: Configure .bashrc
      lineinfile:
        dest: /root/.bashrc
        line: "{{ item }}"
      with_items:
        - 'export KUBECONFIG=/etc/kubernetes/admin.conf'
        - 'source <(kubectl completion bash)'
        - 'alias k=kubectl'
        - 'complete -F __start_kubectl k'

    #- name: kubeadm config pull
    #  command: kubeadm config images pull
# TODO idempotent

    - name: kubeadm init
      command: >
        kubeadm init
        --pod-network-cidr 10.244.0.0/16
        --apiserver-advertise-address "{{ ansible_eth1.ipv4.address }}"
      args:
        creates: /etc/kubernetes/admin.conf

    - name: kube flannel
      command: >
        kubectl
        --kubeconfig=/etc/kubernetes/admin.conf
        apply
        -f
        https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml

    - name: kube dashboard
      command: >
        kubectl
        --kubeconfig=/etc/kubernetes/admin.conf
        apply
        -f
        https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml

    - name: kube clusteradmin
      command: >
        kubectl
        --kubeconfig=/etc/kubernetes/admin.conf
        create clusterrolebinding
        --user system:serviceaccount:kube-system:default kube-system-cluster-admin
        --clusterrole cluster-admin

    - name: kube dashboardadmin
      command: >
        kubectl
        --kubeconfig=/etc/kubernetes/admin.conf
        create clusterrolebinding kubernetes-dashboard
        --clusterrole=cluster-admin
        --serviceaccount=kube-system:kubernetes-dashboard

    - name: kube adminuser
      command: >
        kubectl
        --kubeconfig=/etc/kubernetes/admin.conf
        apply
        -f ~vagrant/dashboard-adminuser.yaml

    - name: kube adminrole
      command: >
        kubectl
        --kubeconfig=/etc/kubernetes/admin.conf
        apply
        -f ~vagrant/dashboard-adminrole.yaml

    # TODO Nieuwere ymls https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml
    - name: Get join link
      command: kubeadm token create --print-join-command
      register: joinlink

    - name: Start proxy
      cron:
        name: "start proxy"
        special_time: "reboot"
        job: "tmux new-session -d -s proxy 'sleep 60 && kubectl --kubeconfig=/etc/kubernetes/admin.conf proxy --accept-hosts='.*' --address {{ ansible_eth1.ipv4.address }}  |& tee ~/tmux.log '"

    # https://docs.ansible.com/ansible/latest/user_guide/playbooks_delegation.html
    - name: Join workers to master
      command: "{{ joinlink.stdout }}"
      delegate_to: "{{ item }}"
      with_items: "{{ groups['nodes'] }}"

    - name: Reboot master
      reboot:

    - name: Waits for port 6443 of any IP to close active connections, don't start checking for 10 seconds
      wait_for:
        host: "{{ ansible_eth1.ipv4.address }}"
        port: 6443
        delay: 10

    - name: kube adminuser
      shell: kubectl --kubeconfig=/etc/kubernetes/admin.conf describe sa admin-user -n kube-system | awk '/^Tokens/ { print $2 }'
      register: adminuser
      tags: show

    - name: kube token
      shell: kubectl --kubeconfig=/etc/kubernetes/admin.conf describe secret {{ adminuser.stdout }} -n kube-system | awk ' /^token/ { print $2 }'
      register: token
      tags: show

    - name: kube show nodes
      command: >
        kubectl
        --kubeconfig=/etc/kubernetes/admin.conf
        get nodes
      register: getnodes
      tags: show

    - name: show weblink
      debug:
        msg:
          - "Link op http://{{ ansible_eth1.ipv4.address }}:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/"
          - "Token: {{ token.stdout }}"
          - "Nodes: {{ getnodes.stdout_lines }}"
      tags: show
#    - name: show var
#      debug:
#        var: "{{ item }}"
#      loop:
#        - token
#        - adminuser
#        - getnodes.stdout_lines
#      tags: show
    #- name: "Add K8S Token and Hash to dummy host"
    #  add_host:
    #    name:   "K8S_TOKEN_HOLDER"
    #    joinlink:  "{{ joinlink.stdout }}"
#
#- hosts: nodes
## SCope https://liquidat.wordpress.com/2017/09/13/howto-reference-ansible-variables-between-plays/
#  tasks:
#    - name: Get join link
#      command: "{{ hostvars['K8S_TOKEN_HOLDER']['joinlink'] }}"

# http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/
# Vraag je token op met :
# [root@master vagrant]# kubectl describe secret $(kubectl describe sa admin-user -n kube-system | awk '/^Tokens/ { print $2 }') -n kube-system | awk ' /^token/ { print $2 }'

